{% extends "base.html" %}

{% block content %}
<h1 class="title">Filter Recipes by Nutrition</h1>

<!-- Buttons for filtering categories -->
<div id="filter-buttons">
    <button type="button" onclick="showInputs('Calories')">Calories</button>
    <button type="button" onclick="showInputs('Fat')">Fat</button>
    <button type="button" onclick="showInputs('Protein')">Protein</button>
    <button type="button" onclick="showInputs('Carbs')">Carbs</button>
    <!-- Add more buttons as needed -->
</div>

<!-- Dynamic filter form -->
<form id="nutrient-form">
    <div id="dynamic-inputs"></div>
    <button type="submit">Find Recipes</button>
</form>

<!-- Section to display fetched recipes -->
<div id="recipe-results"></div>

<script>
async function getApiKey() {
    const response = await fetch('/get-api-key');
    const data = await response.json();
    return data.api_key;
}

// Maps category to corresponding API parameters
const nutrientMap = {
    "Calories": ["minCalories", "maxCalories"],
    "Fat": ["minFat", "maxFat"],
    "Protein": ["minProtein", "maxProtein"],
    "Carbs": ["minCarbs", "maxCarbs"]
    // Add more categories if desired
};

// Keep track of which filters are already added
const addedCategories = new Set();

function showInputs(category) {
    if (addedCategories.has(category)) return; // Prevent duplicates
    addedCategories.add(category);

    const inputsDiv = document.getElementById("dynamic-inputs");

    const fieldset = document.createElement("fieldset");
    fieldset.innerHTML = `<legend>${category} Range</legend>`;

    nutrientMap[category].forEach(param => {
        const label = document.createElement("label");
        label.htmlFor = param;
        label.innerText = param + ":";

        const input = document.createElement("input");
        input.type = "number";
        input.id = param;
        input.name = param;
        input.step = "any";
        input.min = "0";

        fieldset.appendChild(label);
        fieldset.appendChild(input);
        fieldset.appendChild(document.createElement("br"));
    });

    inputsDiv.appendChild(fieldset);
}

document.getElementById("nutrient-form").addEventListener("submit", async function(event) {
    event.preventDefault();
    const apiKey = await getApiKey();

    const formElements = document.getElementById("nutrient-form").elements;
    let queryParams = [];

    for (let elem of formElements) {
        if (elem.name && elem.value) {
            queryParams.push(`${encodeURIComponent(elem.name)}=${encodeURIComponent(elem.value)}`);
        }
    }

    queryParams.push("number=10");
    queryParams.push(`apiKey=${apiKey}`);

    const url = `https://api.spoonacular.com/recipes/findByNutrients?${queryParams.join("&")}`;

    try {
        const response = await fetch(url);
        const recipes = await response.json();

        const resultsDiv = document.getElementById("recipe-results");
        resultsDiv.innerHTML = "";

        if (recipes.length === 0) {
            resultsDiv.innerHTML = "<p>No recipes found. Try different criteria.</p>";
            return;
        }

        for (let recipe of recipes) {
            const detailsUrl = `https://api.spoonacular.com/recipes/${recipe.id}/information?apiKey=${apiKey}`;
            const detailsResponse = await fetch(detailsUrl);
            const detailsData = await detailsResponse.json();

            const recipeHtml = `
                <div>
                    <h2>${detailsData.title}</h2>
                    <img src="${detailsData.image}" alt="${detailsData.title}">
                    <p><strong>Calories:</strong> ${recipe.calories}</p>
                    <p><strong>Protein:</strong> ${recipe.protein}</p>
                    <p><strong>Fat:</strong> ${recipe.fat}</p>
                    <p><strong>Carbs:</strong> ${recipe.carbs}</p>
                    <p><strong>Ready in:</strong> ${detailsData.readyInMinutes} minutes</p>
                    <p><strong>Servings:</strong> ${detailsData.servings}</p>
                    <h3>Ingredients:</h3>
                    <ul>
                        ${detailsData.extendedIngredients.map(ing => `<li>${ing.original}</li>`).join('')}
                    </ul>
                    <h3>Instructions:</h3>
                    <p>${detailsData.instructions || "No instructions available."}</p>
                </div>
                <hr>
            `;
            resultsDiv.innerHTML += recipeHtml;
        }
    } catch (error) {
        console.error("Error fetching recipes:", error);
        document.getElementById("recipe-results").innerHTML = "<p>Error fetching recipes. Please try again.</p>";
    }
});
</script>
{% endblock %}
